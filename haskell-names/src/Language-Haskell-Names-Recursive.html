<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Language/Haskell/Names/Recursive.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies, ScopedTypeVariables #-}</span>
<a name="line-2"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>Recursive</span>
<a name="line-3"></a>  <span class='hs-layout'>(</span> <span class='hs-varid'>computeInterfaces</span>
<a name="line-4"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getInterfaces</span>
<a name="line-5"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>annotateModule</span>
<a name="line-6"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Graph</span><span class='hs-layout'>(</span><span class='hs-varid'>stronglyConnComp</span><span class='hs-layout'>,</span> <span class='hs-varid'>flattenSCC</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Set</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>forM_</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Exts</span><span class='hs-varop'>.</span><span class='hs-conid'>Annotated</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution</span><span class='hs-varop'>.</span><span class='hs-conid'>HaskellSuite</span><span class='hs-varop'>.</span><span class='hs-conid'>Modules</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Foldable</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>SyntaxUtils</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>ScopeUtils</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>ModuleSymbols</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>Exports</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>Imports</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>Open</span><span class='hs-varop'>.</span><span class='hs-conid'>Base</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span><span class='hs-varop'>.</span><span class='hs-conid'>Annotated</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="groupModules"></a><span class='hs-comment'>-- | Take a set of modules and return a list of sets, where each sets for</span>
<a name="line-28"></a><span class='hs-comment'>-- a strongly connected component in the import graph.</span>
<a name="line-29"></a><span class='hs-comment'>-- The boolean determines if imports using @SOURCE@ are taken into account.</span>
<a name="line-30"></a><span class='hs-definition'>groupModules</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>l</span> <span class='hs-varop'>.</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a><span class='hs-definition'>groupModules</span> <span class='hs-varid'>modules</span> <span class='hs-keyglyph'>=</span>
<a name="line-32"></a>  <span class='hs-varid'>map</span> <span class='hs-varid'>flattenSCC</span> <span class='hs-varop'>$</span> <span class='hs-varid'>stronglyConnComp</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkNode</span> <span class='hs-varid'>modules</span>
<a name="line-33"></a>  <span class='hs-keyword'>where</span>
<a name="line-34"></a>    <span class='hs-varid'>mkNode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleName</span> <span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span> <span class='hs-conid'>()</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-varid'>mkNode</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span>
<a name="line-36"></a>      <span class='hs-layout'>(</span> <span class='hs-varid'>m</span>
<a name="line-37"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>dropAnn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getModuleName</span> <span class='hs-varid'>m</span>
<a name="line-38"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropAnn</span> <span class='hs-varop'>.</span> <span class='hs-varid'>importModule</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getImports</span> <span class='hs-varid'>m</span>
<a name="line-39"></a>      <span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="annotateModule"></a><span class='hs-comment'>-- | Annotate a module with scoping information. This assumes that all</span>
<a name="line-42"></a><span class='hs-comment'>-- module dependencies have been resolved and cached â€” usually you need</span>
<a name="line-43"></a><span class='hs-comment'>-- to run 'computeInterfaces' first, unless you have one module in</span>
<a name="line-44"></a><span class='hs-comment'>-- isolation.</span>
<a name="line-45"></a><span class='hs-definition'>annotateModule</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadModule</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>Symbols</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcInfo</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Language</span> <span class='hs-comment'>-- ^ base language</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Extension</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ global extensions (e.g. specified on the command line)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-varid'>l</span> <span class='hs-comment'>-- ^ input module</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scoped</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ output (annotated) module</span>
<a name="line-51"></a><span class='hs-definition'>annotateModule</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>exts</span> <span class='hs-varid'>mod</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Module</span> <span class='hs-varid'>lm</span> <span class='hs-varid'>mh</span> <span class='hs-varid'>os</span> <span class='hs-varid'>is</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-52"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>extSet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleExtensions</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>exts</span> <span class='hs-varid'>mod</span>
<a name="line-53"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>imp</span><span class='hs-layout'>,</span> <span class='hs-varid'>impTbl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>processImports</span> <span class='hs-varid'>extSet</span> <span class='hs-varid'>is</span>
<a name="line-54"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ownTbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleTable</span> <span class='hs-varid'>mod</span>
<a name="line-55"></a>      <span class='hs-varid'>tbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>impTbl</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ownTbl</span>
<a name="line-56"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-sel'>_syms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>processExports</span> <span class='hs-varid'>tbl</span> <span class='hs-varid'>mod</span>
<a name="line-57"></a>
<a name="line-58"></a>  <span class='hs-keyword'>let</span>
<a name="line-59"></a>    <span class='hs-varid'>lm'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>none</span> <span class='hs-varid'>lm</span>
<a name="line-60"></a>    <span class='hs-varid'>os'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>noScope</span> <span class='hs-varid'>os</span>
<a name="line-61"></a>    <span class='hs-varid'>is'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp</span>
<a name="line-62"></a>    <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotate</span> <span class='hs-layout'>(</span><span class='hs-varid'>initialScope</span> <span class='hs-varid'>tbl</span><span class='hs-layout'>)</span> <span class='hs-varop'>`map`</span> <span class='hs-varid'>ds</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-varid'>mh'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>mh</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleHead</span> <span class='hs-varid'>lh</span> <span class='hs-varid'>n</span> <span class='hs-varid'>mw</span> <span class='hs-sel'>_me</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-65"></a>      <span class='hs-keyword'>let</span>
<a name="line-66"></a>        <span class='hs-varid'>lh'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>none</span> <span class='hs-varid'>lh</span>
<a name="line-67"></a>        <span class='hs-varid'>n'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noScope</span> <span class='hs-varid'>n</span>
<a name="line-68"></a>        <span class='hs-varid'>mw'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>noScope</span> <span class='hs-varid'>mw</span>
<a name="line-69"></a>        <span class='hs-varid'>me'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span>
<a name="line-70"></a>      <span class='hs-keyword'>in</span> <span class='hs-conid'>ModuleHead</span> <span class='hs-varid'>lh'</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>mw'</span> <span class='hs-varid'>me'</span>
<a name="line-71"></a>
<a name="line-72"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Module</span> <span class='hs-varid'>lm'</span> <span class='hs-varid'>mh'</span> <span class='hs-varid'>os'</span> <span class='hs-varid'>is'</span> <span class='hs-varid'>ds'</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-definition'>annotateModule</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"annotateModule: non-standard modules are not supported"</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="findFixPoint"></a><span class='hs-comment'>-- | Compute interfaces for a set of mutually recursive modules and write</span>
<a name="line-77"></a><span class='hs-comment'>-- the results to the cache. Return the set of import/export errors.</span>
<a name="line-78"></a><span class='hs-definition'>findFixPoint</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadModule</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>Symbols</span><span class='hs-layout'>)</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Module</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExtensionSet</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a>      <span class='hs-comment'>-- ^ module and all extensions with which it is to be compiled.</span>
<a name="line-82"></a>      <span class='hs-comment'>-- Use 'moduleExtensions' to build this list.</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Error</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-definition'>findFixPoint</span> <span class='hs-varid'>mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mods</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>mempty</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-85"></a>  <span class='hs-varid'>go</span> <span class='hs-varid'>mods</span> <span class='hs-varid'>syms</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-86"></a>    <span class='hs-varid'>forM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>syms</span> <span class='hs-varid'>mods</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>insertInCache</span> <span class='hs-layout'>(</span><span class='hs-varid'>getModuleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-87"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>syms'</span><span class='hs-layout'>,</span> <span class='hs-varid'>errors</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>unzip</span> <span class='hs-varop'>$</span> <span class='hs-varid'>forM</span> <span class='hs-varid'>mods</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>extSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-88"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>imp</span><span class='hs-layout'>,</span> <span class='hs-varid'>impTbl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>processImports</span> <span class='hs-varid'>extSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getImports</span> <span class='hs-varid'>m</span>
<a name="line-89"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>ownTbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleTable</span> <span class='hs-varid'>m</span>
<a name="line-90"></a>          <span class='hs-varid'>tbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>impTbl</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ownTbl</span>
<a name="line-91"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>exp</span><span class='hs-layout'>,</span> <span class='hs-varid'>syms</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>processExports</span> <span class='hs-varid'>tbl</span> <span class='hs-varid'>m</span>
<a name="line-92"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>syms</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>getErrors</span> <span class='hs-varid'>imp</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>getErrors</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span>
<a name="line-93"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>syms'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>syms</span>
<a name="line-94"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mconcat</span> <span class='hs-varid'>errors</span>
<a name="line-95"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mods</span> <span class='hs-varid'>syms'</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="computeInterfaces"></a><span class='hs-comment'>-- | 'computeInterfaces' takes a list of possibly recursive modules and</span>
<a name="line-98"></a><span class='hs-comment'>-- computes the interface of each module. The computed interfaces are</span>
<a name="line-99"></a><span class='hs-comment'>-- written into the @m@'s cache and are available to further computations</span>
<a name="line-100"></a><span class='hs-comment'>-- in this monad.</span>
<a name="line-101"></a><span class='hs-comment'>--</span>
<a name="line-102"></a><span class='hs-comment'>-- Returns the set of import/export errors. Note that the interfaces are</span>
<a name="line-103"></a><span class='hs-comment'>-- registered in the cache regardless of whether there are any errors, but</span>
<a name="line-104"></a><span class='hs-comment'>-- if there are errors, the interfaces may be incomplete.</span>
<a name="line-105"></a><span class='hs-definition'>computeInterfaces</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadModule</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>Symbols</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcInfo</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Language</span> <span class='hs-comment'>-- ^ base language</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Extension</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ global extensions (e.g. specified on the command line)</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ input modules</span>
<a name="line-110"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Error</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ errors in export or import lists</span>
<a name="line-111"></a><span class='hs-definition'>computeInterfaces</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>exts</span> <span class='hs-keyglyph'>=</span>
<a name="line-112"></a>  <span class='hs-varid'>liftM</span> <span class='hs-varid'>fold</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>findFixPoint</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>supplyExtensions</span> <span class='hs-varop'>.</span> <span class='hs-varid'>groupModules</span>
<a name="line-113"></a>    <span class='hs-keyword'>where</span>
<a name="line-114"></a>    <span class='hs-varid'>supplyExtensions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>moduleExtensions</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>exts</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="getInterfaces"></a><span class='hs-comment'>-- | Like 'computeInterfaces', but also returns a list of interfaces, one</span>
<a name="line-117"></a><span class='hs-comment'>-- per module and in the same order</span>
<a name="line-118"></a><span class='hs-definition'>getInterfaces</span>
<a name="line-119"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadModule</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleInfo</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>Symbols</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcInfo</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Language</span> <span class='hs-comment'>-- ^ base language</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Extension</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ global extensions (e.g. specified on the command line)</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ input modules</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Symbols</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Error</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ output modules, and errors in export or import lists</span>
<a name="line-124"></a><span class='hs-definition'>getInterfaces</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>exts</span> <span class='hs-varid'>mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-125"></a>  <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>computeInterfaces</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>exts</span> <span class='hs-varid'>mods</span>
<a name="line-126"></a>  <span class='hs-varid'>ifaces</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forM</span> <span class='hs-varid'>mods</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-127"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>modName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getModuleName</span> <span class='hs-varid'>mod</span> <span class='hs-keyword'>in</span>
<a name="line-128"></a>    <span class='hs-varid'>fromMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>modName</span><span class='hs-layout'>)</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>lookupInCache</span> <span class='hs-varid'>modName</span>
<a name="line-129"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ifaces</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span>
<a name="line-130"></a>  <span class='hs-keyword'>where</span>
<a name="line-131"></a>    <span class='hs-varid'>msg</span> <span class='hs-varid'>modName</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"getInterfaces: module "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>modToString</span> <span class='hs-varid'>modName</span> <span class='hs-varop'>++</span> <span class='hs-str'>" is not in the cache"</span>
</pre></body>
</html>
